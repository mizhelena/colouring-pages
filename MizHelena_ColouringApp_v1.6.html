<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Yiayia & Sienna‚Äôs Colouring Fun</title>
<style>
 html,body{
   margin:0; font-family:'Poppins',system-ui,sans-serif;
   background:linear-gradient(135deg,#ffeaf5,#e6f4ff,#fff5fb); color:#333;
 }
 header{text-align:center;padding:12px 0;}
 header h1{margin:0;font-size:1.9rem;line-height:1.3;text-align:center;}
 #toolbar{
   display:flex;justify-content:center;align-items:center;flex-wrap:wrap;
   background:rgba(255,255,255,0.9);padding:8px;gap:10px;
   box-shadow:0 2px 6px rgba(0,0,0,.1);position:sticky;top:0;z-index:10;
 }
 button{
   border:none;border-radius:12px;background:white;padding:8px 14px;font-size:.9rem;cursor:pointer;color:#333;
   box-shadow:0 2px 5px rgba(0,0,0,.1);transition:all .2s;
 }
 button:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15);}
 button.active{background:#ffe4f0;font-weight:bold;}
 .sizegroup{display:flex;align-items:center;gap:8px;background:white;border-radius:12px;
   padding:6px 10px;box-shadow:0 2px 5px rgba(0,0,0,.1);}
 .sizegroup input[type=range]{width:140px}
 #palette{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin:10px;}
 .color{width:28px;height:28px;border-radius:50%;border:2px solid white;box-shadow:0 1px 3px rgba(0,0,0,.2);cursor:pointer;}
 #thumbs{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
 #thumbs img{width:110px;border-radius:6px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.15);transition:.2s;}
 #thumbs img:hover{transform:scale(1.05);}
 .canvas-wrap{position:relative;width:min(800px,95vw);margin:20px auto;}
 #bgCanvas{
   display:block;width:100%;height:auto;border-radius:10px;background:white;
   box-shadow:0 2px 6px rgba(0,0,0,.15);
 }
 #paintCanvas{
   position:absolute;inset:0;width:100%;height:100%;
   border-radius:10px;touch-action:none;
 }
 #stickers{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
 #stickers img{width:60px;height:60px;cursor:pointer;border-radius:10px;transition:transform .2s;box-shadow:0 2px 5px rgba(0,0,0,.1);}
 #stickers img:hover{transform:scale(1.1);}
 footer{text-align:center;font-size:.9rem;color:#666;padding:14px 0 24px;}
 footer a{color:#888;text-decoration:none;} footer a:hover{text-decoration:underline;}
</style>
</head>
<body>
<header>
 <h1>üñçÔ∏èüåà Yiayia & Sienna‚Äôs Colouring Fun</h1>
</header>

<div id="toolbar">
 <button id="drawBtn" class="active">üñçÔ∏è Draw</button>
 <button id="stickerBtn">üå∏ Sticker</button>
 <button id="eraseBtn">ü©π Erase</button>
 <button id="clearBtn">üßº Clear</button>
 <button id="saveBtn">üíæ Save</button>
 <div class="sizegroup">
   <label for="size">üñåÔ∏è Size</label>
   <input id="size" type="range" min="2" max="48" value="12">
 </div>
</div>

<div id="palette"></div>

<div id="thumbs">
 <img src="page1.png"><img src="page2.png"><img src="page3.png">
 <img src="page4.png"><img src="page5.png"><img src="page6.png">
</div>

<div class="canvas-wrap">
  <canvas id="bgCanvas" width="800" height="800"></canvas>
  <canvas id="paintCanvas" width="800" height="800"></canvas>
</div>

<div id="stickers">
 <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2764.png" alt="heart">
 <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2b50.png" alt="star">
 <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f33c.png" alt="flower">
 <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f98b.png" alt="butterfly">
 <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f308.png" alt="rainbow">
</div>

<footer>
 Made with ‚ù§Ô∏è by Miz Helena Children‚Äôs Books ¬∑
 <a href="https://mizhelenabooks.com.au" target="_blank">mizhelenabooks.com.au</a>
</footer>

<script>
const bgCanvas=document.getElementById("bgCanvas");
const paintCanvas=document.getElementById("paintCanvas");
const bgCtx=bgCanvas.getContext("2d");
const ctx=paintCanvas.getContext("2d");

let drawing=false,color="#000",size=12,mode="draw",currentImg=null,selectedSticker=null;
document.getElementById("size").addEventListener("input",e=>size=parseInt(e.target.value,10));

function getCanvasPos(evt){
  const rect=paintCanvas.getBoundingClientRect();
  const scaleX=paintCanvas.width/rect.width;
  const scaleY=paintCanvas.height/rect.height;
  return {x:(evt.clientX-rect.left)*scaleX,y:(evt.clientY-rect.top)*scaleY};
}

function drawLine(pos){
  ctx.lineWidth=size;
  ctx.lineCap="round";
  if(mode==="erase"){
    ctx.globalCompositeOperation="destination-out";
  }else{
    ctx.globalCompositeOperation="source-over";
    ctx.strokeStyle=color;
  }
  ctx.lineTo(pos.x,pos.y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(pos.x,pos.y);
}

paintCanvas.addEventListener("pointerdown",e=>{
  const pos=getCanvasPos(e);
  if(mode==="draw"||mode==="erase"){
    drawing=true;ctx.beginPath();ctx.moveTo(pos.x,pos.y);
  }else if(mode==="sticker"&&selectedSticker){
    const img=new Image();
    img.crossOrigin = "anonymous";     // ‚úÖ allow saving after drawing external sticker
    img.src=selectedSticker;
    img.onload=()=>ctx.drawImage(img,pos.x-30,pos.y-30,60,60);
  }
});
paintCanvas.addEventListener("pointermove",e=>{
  if(drawing&&(mode==="draw"||mode==="erase"))drawLine(getCanvasPos(e));
});
paintCanvas.addEventListener("pointerup",()=>{drawing=false;ctx.beginPath();ctx.globalCompositeOperation="source-over";});

// Palette
(function(){
  const colours=["#e74c3c","#e67e22","#f1c40f","#2ecc71","#3498db","#9b59b6","#ff8bd6","#ffffff",
  "#7f8c8d","#808000","#ffd700","#ff7f50","#dda0dd","#5dade2","#2c3e50","#8b4513","#f5deb3",
  "#708090","#ffc0cb","#b0e0e6","#f8c8dc","#9370db","#fff176","#ffb347","#90ee90","#e0e0e0",
  "#87cefa","#b39ddb","#ffcc80","#ffb6c1"];
  const p=document.getElementById("palette");
  colours.forEach(c=>{
    const d=document.createElement("div");
    d.className="color";d.style.background=c;d.onclick=()=>color=c;p.appendChild(d);
  });
})();

// Thumbnails (set CORS just in case in future you host images elsewhere)
document.querySelectorAll("#thumbs img").forEach(img=>{
  img.onclick=()=>{
    const i=new Image();
    i.crossOrigin = "anonymous";  // ‚úÖ harmless for local, required if remote later
    i.onload=()=>{currentImg=i;bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);bgCtx.drawImage(i,0,0,bgCanvas.width,bgCanvas.height);};
    i.src=img.src;
  };
});
if(document.querySelector("#thumbs img"))document.querySelector("#thumbs img").click();

// Toolbar modes
["draw","sticker","erase"].forEach(m=>{
  document.getElementById(m+"Btn").onclick=()=>{
    mode=m;
    document.querySelectorAll("#toolbar button").forEach(b=>b.classList.remove("active"));
    document.getElementById(m+"Btn").classList.add("active");
  };
});

// Clear paint layer only
document.getElementById("clearBtn").onclick=()=>{ctx.clearRect(0,0,paintCanvas.width,paintCanvas.height);};

// ‚úÖ UNIVERSAL SAVE (toBlob + mobile fallback)
document.getElementById("saveBtn").onclick=()=>{
  const out=document.createElement("canvas");
  out.width=800;out.height=800;
  const octx=out.getContext("2d");
  octx.drawImage(bgCanvas,0,0);
  octx.drawImage(paintCanvas,0,0);

  // Prefer Blob (more reliable for downloads)
  if (out.toBlob) {
    out.toBlob((blob)=>{
      if(!blob){ return fallback(); }
      const url=URL.createObjectURL(blob);
      const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      if(isMobile){
        const win=window.open();
        if(win){
          win.document.write("<title>Yiayia & Sienna‚Äôs Artwork</title>");
          win.document.write("<img src='"+url+"' style='width:100%;height:auto;display:block;margin:auto;'>");
          win.document.write("<p style='text-align:center;font-family:sans-serif;'>Tap and hold to save your artwork üé®</p>");
          win.document.close();
        }else{
          const a=document.createElement("a");
          a.href=url;a.target="_blank";document.body.appendChild(a);a.click();document.body.removeChild(a);
        }
      }else{
        const a=document.createElement("a");
        a.href=url;a.download="Yiayia_Sienna_Artwork.png";
        document.body.appendChild(a);a.click();document.body.removeChild(a);
      }
      setTimeout(()=>URL.revokeObjectURL(url),1500);
    },"image/png");
  } else {
    fallback();
  }

  function fallback(){
    try{
      const dataURL=out.toDataURL("image/png");
      const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      if(isMobile){
        const win=window.open();
        if(win){
          win.document.write("<title>Yiayia & Sienna‚Äôs Artwork</title>");
          win.document.write("<img src='"+dataURL+"' style='width:100%;height:auto;display:block;margin:auto;'>");
          win.document.write("<p style='text-align:center;font-family:sans-serif;'>Tap and hold to save your artwork üé®</p>");
          win.document.close();
        }
      }else{
        const a=document.createElement("a");
        a.href=dataURL;a.download="Yiayia_Sienna_Artwork.png";
        document.body.appendChild(a);a.click();document.body.removeChild(a);
      }
    }catch(e){
      alert("If saving didn‚Äôt work, try a hard refresh (Cmd/Ctrl+Shift+R) and try again.");
      console.error(e);
    }
  }
};

// Stickers (choose, then tap on canvas to place)
document.querySelectorAll("#stickers img").forEach(st=>{
  st.addEventListener("click",()=>{
    selectedSticker=st.src;
    mode="sticker";
    document.querySelectorAll("#toolbar button").forEach(b=>b.classList.remove("active"));
    document.getElementById("stickerBtn").classList.add("active");
  });
});
</script>
</body>
</html>

