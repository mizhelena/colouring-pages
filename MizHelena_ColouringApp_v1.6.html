<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yiayia & Sienna‚Äôs Colouring Fun</title>
<style>
  html,body{
    margin:0;
    font-family:'Poppins',system-ui,sans-serif;
    background:linear-gradient(135deg,#ffeaf5,#e6f4ff,#fff5fb);
    color:#333;
  }
  header{text-align:center;padding:12px 0;}
  header h1{margin:0;font-size:1.9rem;line-height:1.3;}

  #toolbar{
    display:flex;justify-content:center;align-items:center;flex-wrap:wrap;
    background:rgba(255,255,255,0.9);padding:8px;gap:10px;
    box-shadow:0 2px 6px rgba(0,0,0,.1);position:sticky;top:0;z-index:10;
  }
  button{
    border:none;border-radius:12px;background:white;padding:8px 14px;font-size:.9rem;cursor:pointer;color:#333;
    box-shadow:0 2px 5px rgba(0,0,0,.1);transition:all .2s;
  }
  button:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15);}
  button.active{background:#ffe4f0;font-weight:bold;}
  .sizegroup{display:flex;align-items:center;gap:8px;background:white;border-radius:12px;
    padding:6px 10px;box-shadow:0 2px 5px rgba(0,0,0,.1);}
  .sizegroup input[type=range]{width:140px}

  /* Palette (always visible, no JS needed to show) */
  #palette{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin:10px;}
  .chip{width:28px;height:28px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.2);cursor:pointer;}

  #thumbs{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
  #thumbs img{width:110px;border-radius:6px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.15);transition:.2s;}
  #thumbs img:hover{transform:scale(1.05);}

  /* Canvas stage: two canvases stacked (background + paint overlay) */
  .stage{position:relative;width:min(800px,95vw);margin:20px auto;}
  #bgCanvas,#paintCanvas{
    width:100%;height:auto;border-radius:10px;display:block;
    box-shadow:0 2px 6px rgba(0,0,0,.15);
    touch-action:none; /* we handle gestures ourselves */
  }
  #paintCanvas{
    position:absolute;left:0;top:0; /* overlay */
    box-shadow:none; /* avoid double shadow */
  }

  #stickers{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
  #stickers img{width:60px;height:60px;cursor:pointer;border-radius:10px;transition:transform .2s;box-shadow:0 2px 5px rgba(0,0,0,.1);}
  #stickers img:hover{transform:scale(1.1);}

  footer{text-align:center;font-size:.9rem;color:#666;padding:14px 0 24px;}
  footer a{color:#888;text-decoration:none;} footer a:hover{text-decoration:underline;}
</style>
</head>
<body>
<header><h1>üñçÔ∏èüåà Yiayia & Sienna‚Äôs Colouring Fun</h1></header>

<div id="toolbar">
  <button id="drawBtn" class="active">üñçÔ∏è Draw</button>
  <button id="stickerBtn">üå∏ Sticker</button>
  <button id="eraseBtn">ü©π Erase</button>
  <button id="clearBtn">üßº Clear</button>
  <button id="saveBtn">üíæ Save</button>
  <div class="sizegroup">
    <label for="size">üñåÔ∏è Size</label>
    <input id="size" type="range" min="2" max="48" value="12">
  </div>
</div>

<!-- Palette chips (click to set color) -->
<div id="palette">
  <div class="chip" style="background:#e74c3c" onclick="color='#e74c3c'"></div>
  <div class="chip" style="background:#e67e22" onclick="color='#e67e22'"></div>
  <div class="chip" style="background:#f1c40f" onclick="color='#f1c40f'"></div>
  <div class="chip" style="background:#2ecc71" onclick="color='#2ecc71'"></div>
  <div class="chip" style="background:#3498db" onclick="color='#3498db'"></div>
  <div class="chip" style="background:#9b59b6" onclick="color='#9b59b6'"></div>
  <div class="chip" style="background:#ff8bd6" onclick="color='#ff8bd6'"></div>
  <div class="chip" style="background:#ffffff;border-color:#ddd" onclick="color='#ffffff'"></div>
  <div class="chip" style="background:#ffc0cb" onclick="color='#ffc0cb'"></div>
  <div class="chip" style="background:#b0e0e6" onclick="color='#b0e0e6'"></div>
  <div class="chip" style="background:#f8c8dc" onclick="color='#f8c8dc'"></div>
  <div class="chip" style="background:#fff176" onclick="color='#fff176'"></div>
  <div class="chip" style="background:#ffb347" onclick="color='#ffb347'"></div>
  <div class="chip" style="background:#90ee90" onclick="color='#90ee90'"></div>
  <div class="chip" style="background:#e0e0e0" onclick="color='#e0e0e0'"></div>
  <div class="chip" style="background:#2c3e50" onclick="color='#2c3e50'"></div>
</div>

<!-- Thumbnails -->
<div id="thumbs">
  <img src="page1.png" alt="page1">
  <img src="page2.png" alt="page2">
  <img src="page3.png" alt="page3">
  <img src="page4.png" alt="page4">
  <img src="page5.png" alt="page5">
  <img src="page6.png" alt="page6">
</div>

<!-- Canvases (stacked) -->
<div class="stage">
  <canvas id="bgCanvas" width="800" height="800"></canvas>
  <canvas id="paintCanvas" width="800" height="800"></canvas>
</div>

<!-- Stickers -->
<div id="stickers">
  <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2764.png" alt="heart">
  <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2b50.png" alt="star">
  <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f33c.png" alt="flower">
  <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f98b.png" alt="butterfly">
  <img crossorigin="anonymous" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f308.png" alt="rainbow">
</div>

<footer>
  Made with ‚ù§Ô∏è by Miz Helena Children‚Äôs Books ¬∑
  <a href="https://mizhelenabooks.com.au" target="_blank">mizhelenabooks.com.au</a>
</footer>

<script>
/* === Canvas & state === */
const bgCanvas = document.getElementById('bgCanvas');
const paintCanvas = document.getElementById('paintCanvas');
const bgCtx = bgCanvas.getContext('2d');
const dispCtx = paintCanvas.getContext('2d'); // display strokes

// Offscreen stroke buffer in image space (stable while zooming)
const paintRaw = document.createElement('canvas');
paintRaw.width = 800; paintRaw.height = 800;
const rawCtx = paintRaw.getContext('2d');

let drawing=false, color='#000', size=12, mode='draw', selectedSticker=null;

// View (true canvas zoom/pan ‚Äî not CSS)
let viewScale = 1, viewX = 0, viewY = 0;
let targetScale = 1, targetX = 0, targetY = 0;
const MIN_SCALE = 1, MAX_SCALE = 1.8;
let rafId = null;

// Background image
let bgImage = new Image();
bgImage.crossOrigin = 'anonymous';

/* === Rendering with the SAME transform for bg & strokes === */
function render(){
  // BG
  bgCtx.setTransform(1,0,0,1,0,0);
  bgCtx.clearRect(0,0,800,800);
  bgCtx.setTransform(viewScale,0,0,viewScale,viewX,viewY);
  if(bgImage) bgCtx.drawImage(bgImage,0,0,800,800);

  // Strokes
  dispCtx.setTransform(1,0,0,1,0,0);
  dispCtx.clearRect(0,0,800,800);
  dispCtx.setTransform(viewScale,0,0,viewScale,viewX,viewY);
  dispCtx.drawImage(paintRaw,0,0);
}

/* Gentle easing of BOTH scale and pan together */
function animate(){
  const k = 0.15; // easing factor (lower = gentler)
  const ds = targetScale - viewScale;
  const dx = targetX - viewX;
  const dy = targetY - viewY;

  // Stop if very close
  if (Math.abs(ds) < 0.001 && Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5){
    viewScale = targetScale; viewX = targetX; viewY = targetY;
    rafId = null; render(); return;
  }
  viewScale += ds * k;
  viewX     += dx * k;
  viewY     += dy * k;

  render();
  rafId = requestAnimationFrame(animate);
}

/* Utility: screen ‚Üí canvas pixels */
function screenToCanvas(clientX, clientY){
  const rect = paintCanvas.getBoundingClientRect();
  const x = (clientX - rect.left) * (paintCanvas.width / rect.width);
  const y = (clientY - rect.top)  * (paintCanvas.height / rect.height);
  return {x,y};
}

/* Utility: set new target zoom AROUND a screen point (keeps it anchored) */
function setTargetZoomAt(clientX, clientY, factor){
  // clamp target scale
  const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, targetScale * factor));

  // Find the world (image) point under the cursor BEFORE zoom
  const {x:sx, y:sy} = screenToCanvas(clientX, clientY);
  const wx = (sx - targetX) / targetScale;
  const wy = (sy - targetY) / targetScale;

  // Choose new target pan so the same world point remains under the cursor AFTER zoom
  targetScale = newScale;
  targetX = sx - wx * targetScale;
  targetY = sy - wy * targetScale;

  if(!rafId) rafId = requestAnimationFrame(animate);
}

/* Image loading */
function loadImage(src){
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = ()=>{ bgImage = img; render(); };
  img.src = src;
}
window.addEventListener('load', ()=>{
  const first = document.querySelector('#thumbs img');
  if(first) loadImage(first.src);
});
document.querySelectorAll('#thumbs img').forEach(img=>{
  img.addEventListener('click', ()=>loadImage(img.src));
});

/* Size slider */
document.getElementById('size').addEventListener('input', e=> size = parseInt(e.target.value,10));

/* Convert pointer to IMAGE coords (inverse of current view) */
function toImageSpace(clientX, clientY){
  const {x:sx, y:sy} = screenToCanvas(clientX, clientY);
  return { x:(sx - viewX)/viewScale, y:(sy - viewY)/viewScale };
}

/* Drawing / erasing / stickers ‚Äî write to rawCtx in image space */
paintCanvas.addEventListener('pointerdown', e=>{
  // Left click / touch only (right click used for panning)
  if (e.button === 2) return;
  const p = toImageSpace(e.clientX, e.clientY);
  if(mode==='draw' || mode==='erase'){
    drawing = true;
    rawCtx.beginPath();
    rawCtx.moveTo(p.x, p.y);
  }else if(mode==='sticker' && selectedSticker){
    const s = new Image(); s.crossOrigin='anonymous';
    s.onload = ()=>{ rawCtx.drawImage(s, p.x-30, p.y-30, 60, 60); render(); };
    s.src = selectedSticker;
  }
});
paintCanvas.addEventListener('pointermove', e=>{
  if(!drawing) return;
  const p = toImageSpace(e.clientX, e.clientY);
  rawCtx.lineWidth = size;
  rawCtx.lineCap = 'round';
  if(mode==='erase'){
    rawCtx.globalCompositeOperation = 'destination-out';
  }else{
    rawCtx.globalCompositeOperation = 'source-over';
    rawCtx.strokeStyle = color;
  }
  rawCtx.lineTo(p.x, p.y);
  rawCtx.stroke();
  rawCtx.beginPath();
  rawCtx.moveTo(p.x, p.y);
  render();
});
paintCanvas.addEventListener('pointerup', ()=>{
  drawing=false; rawCtx.beginPath(); rawCtx.globalCompositeOperation='source-over';
});
paintCanvas.addEventListener('contextmenu', e=>e.preventDefault()); // keep right-click free for pan

/* Toolbar modes */
['draw','sticker','erase'].forEach(m=>{
  document.getElementById(m+'Btn').addEventListener('click', ()=>{
    mode=m;
    document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
    document.getElementById(m+'Btn').classList.add('active');
  });
});

/* Clear strokes */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  rawCtx.setTransform(1,0,0,1,0,0);
  rawCtx.clearRect(0,0,800,800);
  render();
});

/* Save merged PNG (image + strokes in image space) */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const out = document.createElement('canvas');
  out.width = 800; out.height = 800;
  const o = out.getContext('2d');
  if(bgImage) o.drawImage(bgImage,0,0,800,800);
  o.drawImage(paintRaw,0,0);
  out.toBlob(blob=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='Yiayia_Sienna_Artwork.png';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),800);
  },'image/png');
});

/* Stickers select */
document.querySelectorAll('#stickers img').forEach(st=>{
  st.addEventListener('click', ()=>{
    selectedSticker = st.src;
    mode='sticker';
    document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
    document.getElementById('stickerBtn').classList.add('active');
  });
});

/* === Smooth zoom & pan controls === */

/* Desktop: scroll to zoom (gentle) */
function onWheel(e){
  e.preventDefault();
  const factor = 1 - (e.deltaY * 0.001); // small increments
  setTargetZoomAt(e.clientX, e.clientY, factor);
}
bgCanvas.addEventListener('wheel', onWheel, {passive:false});
paintCanvas.addEventListener('wheel', onWheel, {passive:false});

/* Desktop: right-click drag to pan (while zoomed) */
let rightPanning = false, panStartX = 0, panStartY = 0;
function beginRightPan(e){
  if(e.button!==2) return;
  rightPanning = true;
  const {x:sx, y:sy} = screenToCanvas(e.clientX, e.clientY);
  panStartX = sx - targetX;
  panStartY = sy - targetY;
}
function moveRightPan(e){
  if(!rightPanning) return;
  const {x:sx, y:sy} = screenToCanvas(e.clientX, e.clientY);
  targetX = sx - panStartX;
  targetY = sy - panStartY;
  if(!rafId) rafId = requestAnimationFrame(animate);
}
function endRightPan(){ rightPanning = false; }
bgCanvas.addEventListener('mousedown', beginRightPan);
paintCanvas.addEventListener('mousedown', beginRightPan);
window.addEventListener('mousemove', moveRightPan);
window.addEventListener('mouseup', endRightPan);
bgCanvas.addEventListener('contextmenu', e=>e.preventDefault());
paintCanvas.addEventListener('contextmenu', e=>e.preventDefault());

/* Mobile: two-finger pinch to zoom + pan (gentle) */
let prevDist = 0, prevMid = null;
function touchDist(t0,t1){ const dx=t0.clientX-t1.clientX, dy=t0.clientY-t1.clientY; return Math.hypot(dx,dy); }
function touchMid(t0,t1){ return {x:(t0.clientX+t1.clientX)/2, y:(t0.clientY+t1.clientY)/2}; }

function onTouchStart(e){
  if(e.touches.length===2){
    e.preventDefault();
    prevDist = touchDist(e.touches[0], e.touches[1]);
    prevMid = touchMid(e.touches[0], e.touches[1]);
    drawing = false; // don‚Äôt draw while pinching
  }
}
function onTouchMove(e){
  if(e.touches.length===2){
    e.preventDefault();
    const dist = touchDist(e.touches[0], e.touches[1]);
    const mid = touchMid(e.touches[0], e.touches[1]);

    // Zoom around midpoint
    const delta = dist / (prevDist || dist);
    setTargetZoomAt(mid.x, mid.y, delta);
    prevDist = dist;

    // Pan by midpoint motion (towards target with easing)
    const {x:sx, y:sy} = screenToCanvas(mid.x, mid.y);
    const {x:psx, y:psy} = screenToCanvas(prevMid.x, prevMid.y);
    const dx = sx - psx, dy = sy - psy;
    targetX += dx; targetY += dy;
    prevMid = mid;

    if(!rafId) rafId = requestAnimationFrame(animate);
  }
}
function onTouchEnd(e){
  if(e.touches.length<2){ prevDist=0; prevMid=null; }
}
[bgCanvas,paintCanvas].forEach(el=>{
  el.addEventListener('touchstart', onTouchStart, {passive:false});
  el.addEventListener('touchmove',  onTouchMove,  {passive:false});
  el.addEventListener('touchend',   onTouchEnd,   {passive:false});
});

/* Double-click / double-tap to reset (no button needed) */
let lastTap=0;
function onTap(e){
  const now=Date.now();
  if(now-lastTap<350){
    targetScale=1; targetX=0; targetY=0;
    if(!rafId) rafId = requestAnimationFrame(animate);
  }
  lastTap=now;
}
bgCanvas.addEventListener('click', onTap);
paintCanvas.addEventListener('click', onTap);

/* Re-render on resize */
window.addEventListener('resize', render);
</script>
</body>
</html>
